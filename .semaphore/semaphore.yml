version: v1.0
name: Hasura demo
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

  containers:
    - name: main
      image: semaphoreci/ubuntu:18.04
    - name: postgres
      image: postgres
    - name: graphql
      image: hasura/graphql-engine:v1.0.0-beta.2
      env_vars:
        - name: HASURA_GRAPHQL_DATABASE_URL
          value: postgres://postgres:@postgres:5432/postgres
        - name: HASURA_GRAPHQL_ADMIN_SECRET
          value: myadminsecretkey
        - name: HASURA_GRAPHQL_ENABLE_CONSOLE
          value: "true"

blocks:
  - name: "Hasura"
    task:
      env_vars:
        - name: DOCKERIZE_VERSION
          value: v0.3.0
      jobs:
        - name: Test
          commands:
            - wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
            - dockerize -wait tcp:///0.0.0.0:8080 -timeout 1m
            - docker ps
